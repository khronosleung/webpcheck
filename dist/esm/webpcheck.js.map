{"version":3,"file":"webpcheck.js","sources":["../../src/index.js"],"sourcesContent":["const TEST_IMAGES_BASE64 = {\n  lossy: 'UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA',\n  lossless: 'UklGRhoAAABXRUJQVlA4TA0AAAAvAAAAEAcQERGIiP4HAA==',\n  alpha: 'UklGRkoAAABXRUJQVlA4WAoAAAAQAAAAAAAAAAAAQUxQSAwAAAARBxAR/Q9ERP8DAABWUDggGAAAABQBAJ0BKgEAAQAAAP4AAA3AAP7mtQAAAA==',\n  animation: 'UklGRlIAAABXRUJQVlA4WAoAAAASAAAAAAAAAAAAQU5JTQYAAAD/////AABBTk1GJgAAAAAAAAAAAAAAAAAAAGQAAABWUDhMDQAAAC8AAAAQBxAREYiI/gcA',\n};\n\n// ========== 配置\nconst STORAGE_KEY = '_webPCheckResult';\n\nconst localStorageSupported = (() => {\n  try {\n    const str = `test${new Date().getTime()}`;\n    localStorage.setItem(str, str);\n    localStorage.removeItem(str);\n    return true;\n  } catch (e) {\n    return false;\n  }\n})();\n\n// ========== 常用函数\nfunction isType(s, typeString) {\n  return {}.toString.call(s) === `[object ${typeString}]`;\n}\nfunction isObject(s) {\n  return isType(s, 'Object');\n}\nfunction isNull(s) {\n  return isType(s, 'Null');\n}\nfunction storageSetItem(val) {\n  if (localStorageSupported) {\n    localStorage.setItem(STORAGE_KEY, val);\n  }\n}\nfunction storageGetItem() {\n  return localStorageSupported ? localStorage.getItem(STORAGE_KEY) : false;\n}\nfunction storageRemoveItem() {\n  return localStorageSupported ? localStorage.removeItem(STORAGE_KEY) : false;\n}\n\nfunction load(caseItemName, cb) {\n  if (!TEST_IMAGES_BASE64[caseItemName]) {\n    return;\n  }\n\n  let img = new Image();\n  img.onload = () => {\n    cb(caseItemName, (img.width > 0) && (img.height > 0));\n    img.onload = null;\n    img.onerror = null;\n    img = null;\n  };\n  img.onerror = () => {\n    cb(caseItemName, false);\n    img.onload = null;\n    img.onerror = null;\n    img = null;\n  };\n  img.src = `data:image/webp;base64,${TEST_IMAGES_BASE64[caseItemName]}`;\n}\n\nlet WebPCheckResultDetail = null;\nlet WebPCheckResult = null;\nlet WebPCheckState = null;\n\nexport function clean() {\n  WebPCheckResultDetail = null;\n  WebPCheckResult = null;\n  WebPCheckState = null;\n  storageRemoveItem();\n}\n\nexport function result() {\n  if (localStorageSupported) {\n    return JSON.parse(storageGetItem());\n  } if (localStorageSupported === false && isObject(WebPCheckResultDetail)) {\n    return WebPCheckResultDetail;\n  }\n  return false;\n}\n\nexport function state() {\n  return WebPCheckState;\n}\n\n// ========== 检查流程\nfunction WebPCheck() {\n  if (isNull(WebPCheckResult)) {\n    const storageResult = result();\n    if (isObject(storageResult)) {\n      WebPCheckState = 'done';\n      WebPCheckResult = storageResult.lossy\n        || storageResult.lossless\n        || storageResult.alpha\n        || storageResult.animation;\n    } else if (isNull(WebPCheckState) && isNull(WebPCheckResultDetail)) {\n      WebPCheckResultDetail = {};\n      WebPCheckState = 'checking';\n\n      const testCases = ['lossy', 'lossless', 'alpha', 'animation'];\n      // let caseItemName;\n      const totalCheck = testCases.length;\n      let currentCheck = 0;\n\n      testCases.forEach((caseItemName) => {\n        load(caseItemName, (name, response) => {\n          currentCheck += 1;\n\n          WebPCheckResultDetail[name] = response;\n\n          if (totalCheck === currentCheck) {\n            storageSetItem(JSON.stringify(WebPCheckResultDetail));\n            WebPCheckState = 'done';\n          }\n        });\n      });\n    }\n  }\n\n  return !!WebPCheckResult;\n}\n\nexport function check() {\n  return WebPCheck();\n}\n\nif (typeof window !== 'undefined') {\n  WebPCheck();\n}\n"],"names":["TEST_IMAGES_BASE64","lossy","lossless","alpha","animation","STORAGE_KEY","localStorageSupported","str","Date","getTime","localStorage","setItem","removeItem","e","isType","s","typeString","toString","call","isObject","isNull","storageSetItem","val","storageGetItem","getItem","storageRemoveItem","load","caseItemName","cb","img","Image","onload","width","height","onerror","src","WebPCheckResultDetail","WebPCheckResult","WebPCheckState","clean","result","JSON","parse","state","WebPCheck","storageResult","testCases","totalCheck","length","currentCheck","forEach","name","response","stringify","check","window"],"mappings":"AAAA,IAAMA,kBAAkB,GAAG;AACzBC,EAAAA,KAAK,EAAE,0DADkB;AAEzBC,EAAAA,QAAQ,EAAE,kDAFe;AAGzBC,EAAAA,KAAK,EAAE,kHAHkB;AAIzBC,EAAAA,SAAS,EAAE;AAJc,CAA3B;;AAQA,IAAMC,WAAW,GAAG,kBAApB;;AAEA,IAAMC,qBAAqB,GAAI,YAAM;AACnC,MAAI;AACF,QAAMC,GAAG,iBAAU,IAAIC,IAAJ,GAAWC,OAAX,EAAV,CAAT;AACAC,IAAAA,YAAY,CAACC,OAAb,CAAqBJ,GAArB,EAA0BA,GAA1B;AACAG,IAAAA,YAAY,CAACE,UAAb,CAAwBL,GAAxB;AACA,WAAO,IAAP;AACD,GALD,CAKE,OAAOM,CAAP,EAAU;AACV,WAAO,KAAP;AACD;AACF,CAT6B,EAA9B;;;AAYA,SAASC,MAAT,CAAgBC,CAAhB,EAAmBC,UAAnB,EAA+B;AAC7B,SAAO,GAAGC,QAAH,CAAYC,IAAZ,CAAiBH,CAAjB,wBAAmCC,UAAnC,MAAP;AACD;;AACD,SAASG,QAAT,CAAkBJ,CAAlB,EAAqB;AACnB,SAAOD,MAAM,CAACC,CAAD,EAAI,QAAJ,CAAb;AACD;;AACD,SAASK,MAAT,CAAgBL,CAAhB,EAAmB;AACjB,SAAOD,MAAM,CAACC,CAAD,EAAI,MAAJ,CAAb;AACD;;AACD,SAASM,cAAT,CAAwBC,GAAxB,EAA6B;AAC3B,MAAIhB,qBAAJ,EAA2B;AACzBI,IAAAA,YAAY,CAACC,OAAb,CAAqBN,WAArB,EAAkCiB,GAAlC;AACD;AACF;;AACD,SAASC,cAAT,GAA0B;AACxB,SAAOjB,qBAAqB,GAAGI,YAAY,CAACc,OAAb,CAAqBnB,WAArB,CAAH,GAAuC,KAAnE;AACD;;AACD,SAASoB,iBAAT,GAA6B;AAC3B,SAAOnB,qBAAqB,GAAGI,YAAY,CAACE,UAAb,CAAwBP,WAAxB,CAAH,GAA0C,KAAtE;AACD;;AAED,SAASqB,IAAT,CAAcC,YAAd,EAA4BC,EAA5B,EAAgC;AAC9B,MAAI,CAAC5B,kBAAkB,CAAC2B,YAAD,CAAvB,EAAuC;AACrC;AACD;;AAED,MAAIE,GAAG,GAAG,IAAIC,KAAJ,EAAV;;AACAD,EAAAA,GAAG,CAACE,MAAJ,GAAa,YAAM;AACjBH,IAAAA,EAAE,CAACD,YAAD,EAAgBE,GAAG,CAACG,KAAJ,GAAY,CAAb,IAAoBH,GAAG,CAACI,MAAJ,GAAa,CAAhD,CAAF;AACAJ,IAAAA,GAAG,CAACE,MAAJ,GAAa,IAAb;AACAF,IAAAA,GAAG,CAACK,OAAJ,GAAc,IAAd;AACAL,IAAAA,GAAG,GAAG,IAAN;AACD,GALD;;AAMAA,EAAAA,GAAG,CAACK,OAAJ,GAAc,YAAM;AAClBN,IAAAA,EAAE,CAACD,YAAD,EAAe,KAAf,CAAF;AACAE,IAAAA,GAAG,CAACE,MAAJ,GAAa,IAAb;AACAF,IAAAA,GAAG,CAACK,OAAJ,GAAc,IAAd;AACAL,IAAAA,GAAG,GAAG,IAAN;AACD,GALD;;AAMAA,EAAAA,GAAG,CAACM,GAAJ,oCAAoCnC,kBAAkB,CAAC2B,YAAD,CAAtD;AACD;;AAED,IAAIS,qBAAqB,GAAG,IAA5B;AACA,IAAIC,eAAe,GAAG,IAAtB;AACA,IAAIC,cAAc,GAAG,IAArB;AAEO,SAASC,KAAT,GAAiB;AACtBH,EAAAA,qBAAqB,GAAG,IAAxB;AACAC,EAAAA,eAAe,GAAG,IAAlB;AACAC,EAAAA,cAAc,GAAG,IAAjB;AACAb,EAAAA,iBAAiB;AAClB;AAEM,SAASe,MAAT,GAAkB;AACvB,MAAIlC,qBAAJ,EAA2B;AACzB,WAAOmC,IAAI,CAACC,KAAL,CAAWnB,cAAc,EAAzB,CAAP;AACD;;AAAC,MAAIjB,qBAAqB,KAAK,KAA1B,IAAmCa,QAAQ,CAACiB,qBAAD,CAA/C,EAAwE;AACxE,WAAOA,qBAAP;AACD;;AACD,SAAO,KAAP;AACD;AAEM,SAASO,KAAT,GAAiB;AACtB,SAAOL,cAAP;AACD;;AAGD,SAASM,SAAT,GAAqB;AACnB,MAAIxB,MAAM,CAACiB,eAAD,CAAV,EAA6B;AAC3B,QAAMQ,aAAa,GAAGL,MAAM,EAA5B;;AACA,QAAIrB,QAAQ,CAAC0B,aAAD,CAAZ,EAA6B;AAC3BP,MAAAA,cAAc,GAAG,MAAjB;AACAD,MAAAA,eAAe,GAAGQ,aAAa,CAAC5C,KAAd,IACb4C,aAAa,CAAC3C,QADD,IAEb2C,aAAa,CAAC1C,KAFD,IAGb0C,aAAa,CAACzC,SAHnB;AAID,KAND,MAMO,IAAIgB,MAAM,CAACkB,cAAD,CAAN,IAA0BlB,MAAM,CAACgB,qBAAD,CAApC,EAA6D;AAClEA,MAAAA,qBAAqB,GAAG,EAAxB;AACAE,MAAAA,cAAc,GAAG,UAAjB;AAEA,UAAMQ,SAAS,GAAG,CAAC,OAAD,EAAU,UAAV,EAAsB,OAAtB,EAA+B,WAA/B,CAAlB,CAJkE;;AAMlE,UAAMC,UAAU,GAAGD,SAAS,CAACE,MAA7B;AACA,UAAIC,YAAY,GAAG,CAAnB;AAEAH,MAAAA,SAAS,CAACI,OAAV,CAAkB,UAACvB,YAAD,EAAkB;AAClCD,QAAAA,IAAI,CAACC,YAAD,EAAe,UAACwB,IAAD,EAAOC,QAAP,EAAoB;AACrCH,UAAAA,YAAY,IAAI,CAAhB;AAEAb,UAAAA,qBAAqB,CAACe,IAAD,CAArB,GAA8BC,QAA9B;;AAEA,cAAIL,UAAU,KAAKE,YAAnB,EAAiC;AAC/B5B,YAAAA,cAAc,CAACoB,IAAI,CAACY,SAAL,CAAejB,qBAAf,CAAD,CAAd;AACAE,YAAAA,cAAc,GAAG,MAAjB;AACD;AACF,SATG,CAAJ;AAUD,OAXD;AAYD;AACF;;AAED,SAAO,CAAC,CAACD,eAAT;AACD;;AAEM,SAASiB,KAAT,GAAiB;AACtB,SAAOV,SAAS,EAAhB;AACD;;AAED,IAAI,OAAOW,MAAP,KAAkB,WAAtB,EAAmC;AACjCX,EAAAA,SAAS;AACV;;;;"}