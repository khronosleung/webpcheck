{"version":3,"file":"webpcheck.js","sources":["../../src/index.js"],"sourcesContent":["const TEST_IMAGES_BASE64 = {\n  lossy: 'UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA',\n  lossless: 'UklGRhoAAABXRUJQVlA4TA0AAAAvAAAAEAcQERGIiP4HAA==',\n  alpha: 'UklGRkoAAABXRUJQVlA4WAoAAAAQAAAAAAAAAAAAQUxQSAwAAAARBxAR/Q9ERP8DAABWUDggGAAAABQBAJ0BKgEAAQAAAP4AAA3AAP7mtQAAAA==',\n  animation: 'UklGRlIAAABXRUJQVlA4WAoAAAASAAAAAAAAAAAAQU5JTQYAAAD/////AABBTk1GJgAAAAAAAAAAAAAAAAAAAGQAAABWUDhMDQAAAC8AAAAQBxAREYiI/gcA',\n};\n\n// ========== 配置\nconst STORAGE_KEY = '_webPCheckResult';\n\nconst localStorageSupported = (() => {\n  try {\n    const str = `test${new Date().getTime()}`;\n    localStorage.setItem(str, str);\n    localStorage.removeItem(str);\n    return true;\n  } catch (e) {\n    return false;\n  }\n})();\n\n// ========== 常用函数\nfunction isType(s, typeString) {\n  return {}.toString.call(s) === `[object ${typeString}]`;\n}\nfunction isObject(s) {\n  return isType(s, 'Object');\n}\nfunction isNull(s) {\n  return isType(s, 'Null');\n}\nfunction storageSetItem(val) {\n  if (localStorageSupported) {\n    localStorage.setItem(STORAGE_KEY, val);\n  }\n}\nfunction storageGetItem() {\n  return localStorageSupported ? localStorage.getItem(STORAGE_KEY) : false;\n}\nfunction storageRemoveItem() {\n  return localStorageSupported ? localStorage.removeItem(STORAGE_KEY) : false;\n}\n\nfunction load(caseItemName, cb) {\n  if (!TEST_IMAGES_BASE64[caseItemName]) {\n    return;\n  }\n\n  let img = new Image();\n  img.onload = () => {\n    cb(caseItemName, (img.width > 0) && (img.height > 0));\n    img.onload = null;\n    img.onerror = null;\n    img = null;\n  };\n  img.onerror = () => {\n    cb(caseItemName, false);\n    img.onload = null;\n    img.onerror = null;\n    img = null;\n  };\n  img.src = `data:image/webp;base64,${TEST_IMAGES_BASE64[caseItemName]}`;\n}\n\nlet WebPCheckResultDetail = null;\nlet WebPCheckResult = null;\nlet WebPCheckState = null;\n\nexport function clean() {\n  WebPCheckResultDetail = null;\n  WebPCheckResult = null;\n  WebPCheckState = null;\n  storageRemoveItem();\n}\n\nexport function result() {\n  if (localStorageSupported) {\n    return JSON.parse(storageGetItem());\n  } if (localStorageSupported === false && isObject(WebPCheckResultDetail)) {\n    return WebPCheckResultDetail;\n  }\n  return false;\n}\n\nexport function state() {\n  return WebPCheckState;\n}\n\n// ========== 检查流程\nfunction WebPCheck() {\n  if (isNull(WebPCheckResult)) {\n    const storageResult = result();\n    if (isObject(storageResult)) {\n      WebPCheckState = 'done';\n      WebPCheckResult = storageResult.lossy\n        || storageResult.lossless\n        || storageResult.alpha\n        || storageResult.animation;\n    } else if (isNull(WebPCheckState) && isNull(WebPCheckResultDetail)) {\n      WebPCheckResultDetail = {};\n      WebPCheckState = 'checking';\n\n      const testCases = ['lossy', 'lossless', 'alpha', 'animation'];\n      // let caseItemName;\n      const totalCheck = testCases.length;\n      let currentCheck = 0;\n\n      testCases.forEach((caseItemName) => {\n        load(caseItemName, (name, response) => {\n          currentCheck += 1;\n\n          WebPCheckResultDetail[name] = response;\n\n          if (totalCheck === currentCheck) {\n            storageSetItem(JSON.stringify(WebPCheckResultDetail));\n            WebPCheckState = 'done';\n          }\n        });\n      });\n    }\n  }\n\n  return !!WebPCheckResult;\n}\n\nexport function check() {\n  return WebPCheck();\n}\n\nif (typeof window !== 'undefined') {\n  WebPCheck();\n}\n"],"names":["TEST_IMAGES_BASE64","lossy","lossless","alpha","animation","localStorageSupported","str","Date","getTime","localStorage","setItem","removeItem","e","isType","s","typeString","toString","call","isObject","isNull","WebPCheckResultDetail","WebPCheckResult","WebPCheckState","result","JSON","parse","getItem","WebPCheck","storageResult","testCases","totalCheck","length","currentCheck","forEach","caseItemName","cb","img","Image","onload","width","height","onerror","src","load","name","response","val","stringify","window"],"mappings":";AAAA,IAAMA,EAAqB,CACzBC,MAAO,2DACPC,SAAU,mDACVC,MAAO,mHACPC,UAAW,4HAMPC,EAAyB,mBAErBC,iBAAa,IAAIC,MAAOC;OAC9BC,aAAaC,QAAQJ,EAAKA,GAC1BG,aAAaE,WAAWL,IACjB,EACP,MAAOM,UACA,GAPoB;AAY/B,SAASC,EAAOC,EAAGC,SACV,GAAGC,SAASC,KAAKH,uBAAkBC,OAE5C,SAASG,EAASJ,UACTD,EAAOC,EAAG,UAEnB,SAASK,EAAOL,UACPD,EAAOC,EAAG,QAmCnB,IAAIM,EAAwB,KACxBC,EAAkB,KAClBC,EAAiB;AASd,SAASC,WACVlB,EACKmB,KAAKC,QAxCPpB,GAAwBI,aAAaiB,QA7B1B,wBAsEc,IAA1BrB,IAAmCa,EAASE,KACzCA,EAUX,SAASO,OACHR,EAAOE,GAAkB,KACrBO,EAAgBL;GAClBL,EAASU,GACXN,EAAiB,OACjBD,EAAkBO,EAAc3B,OAC3B2B,EAAc1B,UACd0B,EAAczB,OACdyB,EAAcxB;KACd,GAAIe,EAAOG,IAAmBH,EAAOC,GAAwB,CAClEA,EAAwB,GACxBE,EAAiB;IAEXO,EAAY,CAAC,QAAS,WAAY,QAAS,aAE3CC,EAAaD,EAAUE,OACzBC,EAAe;AAEnBH,EAAUI,SAAQ,SAACC,IAhEzB,SAAcA,EAAcC,MACrBnC,EAAmBkC,QAIpBE,EAAM,IAAIC;AACdD,EAAIE,OAAS,WACXH,EAAGD,EAAeE,EAAIG,MAAQ,GAAOH,EAAII,OAAS,GAClDJ,EAAIE,OAAS,KACbF,EAAIK,QAAU,KACdL,EAAM,MAERA,EAAIK,QAAU,WACZN,EAAGD,GAAc,GACjBE,EAAIE,OAAS,KACbF,EAAIK,QAAU,KACdL,EAAM,MAERA,EAAIM,qCAAgC1C,EAAmBkC,KA+CjDS,CAAKT,GAAc,SAACU,EAAMC,GA7ElC,IAAwBC;AA8Edd,GAAgB,EAEhBZ,EAAsBwB,GAAQC,EAE1Bf,IAAeE,IAlFLc,EAmFGtB,KAAKuB,UAAU3B,GAlFpCf,GACFI,aAAaC,QAzBG,mBAyBkBoC,GAkF1BxB,EAAiB,uBAOlBD,EAOW,oBAAX2B,QACTrB,YALK,kBACEA,aA1DF,WACLP,EAAwB,KACxBC,EAAkB,KAClBC,EAAiB,KA/BVjB,GAAwBI,aAAaE,WAhC1B,wCA4Eb,kBACEW"}